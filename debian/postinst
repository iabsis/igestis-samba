#!/bin/sh
# postinst script for igestis-samba
#
# see: dh_installdeb(1)

. /usr/share/debconf/confmodule

# We set some var specific for igestis
MODULE_FOLDER=/usr/share/igestis/modules/Samba
GLOBALVARS=${MODULE_FOLDER}/config/ConfigModuleVars.php

replace_value_global_vars()
{

sed -i "s#const[[:space:]]*$1.*#const $1 = $2;#g" $GLOBALVARS
sed_return_value=$?

if [ ! "$sed_return_value" = 0 ] ; then
    echo "error : the variable $1 was not found in the file $GLOBALVARS"
fi

}

get_value_global_vars()
{

grep "^[[:space:]]*const[[:space:]]*$1" $GLOBALVARS | \
  sed "s#^[[:space:]]*const[[:space:]]$1[[:space:]]=[[:space:]]##g" | \
  sed 's/[ ;][[:space:]]*$//g'

}


#DEBHELPER#


case "$1" in
    configure)

    # Config file creation from template.
    if [ -e "$GLOBALVARS" ] ; then

		# Backup of old config file-
        mkdir -p /var/backup/igestis/Samba/ && chmod 700 /var/backup/igestis/Samba/
		cp $GLOBALVARS /var/backup/igestis/Samba/ConfigModuleVars-$(date "+%Y%M%d_%H%M").php.backup

		ucf --debconf-ok ${MODULE_FOLDER}/config/ConfigModuleVars-template.php $GLOBALVARS

	else

		cp ${MODULE_FOLDER}/config/ConfigModuleVars-template.php $GLOBALVARS
		
	fi
	
	# Setup the localSID
	LOCALSID=$([ -e /usr/bin/net ] && net getlocalsid | cut -d: -f 2 | sed "s/ //g")
	[ -z "$LOCALSID" ] && echo "Warning : Samba is not installed on this server, please set sambaSID constant in ConfigModuleVars.php manually."
	replace_value_global_vars sambaSID \"${LOCALSID}\"
	
	# Setup the Hostname
	HOSTNAME=$(hostname)
	[ -z "$HOSTNAME" ] && echo "Warning : The hostname has not be defined properly."
	replace_value_global_vars profilePath \"\\\\\\\\${HOSTNAME}\\\\%u\\\\.profiles\"
	replace_value_global_vars homePath \"\\\\\\\\${HOSTNAME}\\\\%u\"
	replace_value_global_vars serverName \"${HOSTNAME}\"

	
	# To avoid config missing, we need to create a symbolic link
	ucfr igestis-samba "$GLOBALVARS"

	db_get igestis_samba/install_ldap
	USE_LDAP="${RET}"

	if [ "$USE_LDAP" = true ] ; then

		db_get igestis/ldap/base
		LDAP_BASE="${RET}"

		db_get igestis/ldap/uris
		LDAP_URIS="${RET}"

		db_get igestis/ldap/admin
		LDAP_ADMIN="${RET}"

		db_get igestis/ldap/password
		LDAP_PASSWORD="${RET}"

		# Replace correct OpenLDAP base.
		for i in igestis-samba-indexes.ldif igestis-samba-populate.ldif igestis-samba-schema.ldif ; do
		    if [ -e /usr/share/doc/igestis-samba/ldap/$i.gz ] ; then
		        gzip -d /usr/share/doc/igestis-samba/ldap/$i.gz
		    fi
		    sed -i -e "s/dc=.*,dc=.*/${LDAP_BASE}/g" /usr/share/doc/igestis-samba/ldap/$i
		done
		

		# Adding the Samba Schema
		ldapadd -Y EXTERNAL -H ldapi:/// -f /usr/share/doc/igestis-samba/ldap/igestis-samba-schema.ldif > /dev/null 2>&1 || true
	
		# Addition indexing for Samba
		ldapadd -Y EXTERNAL -H ldapi:/// -f /usr/share/doc/igestis-samba/ldap/igestis-samba-indexes.ldif > /dev/null 2>&1 || true

		# Small patch avoid the password expiring in old igestis version.
		ldapadd -cxD "${LDAP_ADMIN}" -w ${LDAP_PASSWORD} -f /usr/share/doc/igestis-samba/ldap/igestis-samba-populate.ldif > /dev/null 2>&1 || true

		# Replace value in config
		replace_value_global_vars LDAP_COMPUTER_OU \"ou=Machines,${LDAP_BASE}\"

	else
	
        echo "Warning : OpenLDAP is not used by iGestis, please enable it to have this module working properly."

	fi

	db_reset igestis/ldap/password || true


    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0


